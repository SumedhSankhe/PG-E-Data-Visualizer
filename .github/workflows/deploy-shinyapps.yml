name: Deploy to shinyapps.io

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:  # Allow manual deployment

jobs:
  deploy:
    name: Deploy to shinyapps.io
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev

      - name: Restore renv dependencies
        run: |
          R -q -e 'install.packages("renv")'
          R -q -e 'renv::restore(prompt = FALSE)'

      - name: Install rsconnect (deployment tool)
        run: R -q -e 'if(!requireNamespace("rsconnect", quietly=TRUE)) install.packages("rsconnect")'

      - name: Authorize rsconnect
        env:
          SHINYAPPS_ACCOUNT: ${{ secrets.SHINYAPPS_ACCOUNT }}
          SHINYAPPS_TOKEN: ${{ secrets.SHINYAPPS_TOKEN }}
          SHINYAPPS_SECRET: ${{ secrets.SHINYAPPS_SECRET }}
        run: |
          R -e "rsconnect::setAccountInfo(
            name='$SHINYAPPS_ACCOUNT',
            token='$SHINYAPPS_TOKEN',
            secret='$SHINYAPPS_SECRET'
          )"

      - name: Deploy to shinyapps.io
        env:
          SHINYAPPS_ACCOUNT: ${{ secrets.SHINYAPPS_ACCOUNT }}
        run: |
          R -e "rsconnect::deployApp(
            appName = 'PG-E-Data-Visualizer',
            account = '$SHINYAPPS_ACCOUNT',
            forceUpdate = TRUE,
            launch.browser = FALSE,
            logLevel = 'verbose'
          )"

      - name: Deployment summary
        if: success()
        run: |
          echo "‚úÖ Successfully deployed to shinyapps.io!"
          echo "üîó App URL: https://${{ secrets.SHINYAPPS_ACCOUNT }}.shinyapps.io/PG-E-Data-Visualizer/"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed. Check the logs above for details."
          echo "Common issues:"
          echo "  - Missing or incorrect SHINYAPPS_* secrets"
          echo "  - App name mismatch"
          echo "  - Account limit reached"
